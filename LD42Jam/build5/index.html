<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>LD42-Jam</title>
    <style>* { padding: 0; margin: 0; }
    	canvas { background: #eee; display: block; margin: 0 auto; }</style>
</head>
<body>

<div id="game"></div>
<script type="text/javascript"
	src="https://rawgithub.com/craftyjs/Crafty/release/dist/crafty-min.js">
</script>

<!-- <canvas id="Canvas" width="1024" height="896"></canvas> -->
<!-- <canvas id="Canvas" width="1024" height="768"></canvas> -->
<canvas id="Canvas" width="1024" height="768"></canvas>

<script>
	// Copyright © 2018, Pavel M. Dlouhy (game) and Vaclav B. Spiral (music)
	
	var finalBuild = true;
	var gameAudioEnabledDefaultValue = true;
	var devStartFromLevel = 0;
	
	if (!finalBuild)
	{
		gameAudioEnabledDefaultValue = false;
		devStartFromLevel = 0;
		gameAudioEnabled = gameAudioEnabledDefaultValue;
	}
	
	// GLOBAL DATA LAYER
	
	// Helper for Coda Navigator
	function __globalDataLayer()
	{
	}
	
	// COLOR CONSTANTS
	
	var Color1 = "#f3dcd4";
	var Color2 = "#ecc9c7";
	var Color3 = "#d9e3da";
	var Color4 = "#d1cfc0";
	var Color5 = "#c2c2b4";
	var Color6 = "#929284";
	var Color7 = "#abda40";
	
	var levelAreaBGColor = Color3;//"#1c6068";
	var dbgAreaBGColor = "#000000";
	var dbgAreaTextColor = "#00ff00";
	var dialogAreaBGColor = Color4;//"#245aaf";
	var dialogAreaTextColor = Color6;//"#ffffff";
	var dialogSSAreaGoTextColor = Color2;
	var dialogSSAreaBGColor = "#000000";
	var dialogSSAreaTextColor = "#000000";
	
	var levelGreenSlimeColor = Color7;//"#00ff00";
	var levelPlayerColor = Color2;//"#0000ff";
	var levelWallColor = Color6;//"#ff0000";
	var levelYellowBoxColor = "#f9a602"; // Gold
	var levelAreaTextColor = Color6;
	var levelAreaGameMessagesTextColor = "#ffffff";
	var levelAreaGameMessagesTextColorEdge = "#000000";
	
	// CANVAS
	
	var canvas = document.getElementById("Canvas");
	var ctx = canvas.getContext("2d");
	
	// VARIABLES
	
	var levelAreaX = 0;
	var levelAreaY = 0;
	var levelAreaDX = 1024;
	var levelAreaDY = 768;
	var levelAreaTextFont = "32px Arial";
	var levelAreaGameMessagesTextFont = "32px Arial";
	if (!finalBuild)
	{
		levelAreaY = 128;
	}
	
	var dbgAreaX = 0;
	var dbgAreaY = 0;
	var dbgAreaDX = 1024;
	var dbgAreaDY = 128;
	var dbgAreaTextX = 8;
	var dbgAreaTextY = 20;
	var dbgAreaTextYK = 16;
	var dbgAreaTextFont = "16px Arial";
	
	var dialogAreaX = levelAreaX + (levelAreaDX / 2) - (levelAreaDX / 4);
	var dialogAreaY = levelAreaY + (levelAreaDY / 2) - (levelAreaDY / 6);
	var dialogAreaDX = levelAreaDX / 2;
	var dialogAreaDY = levelAreaDY / 3;
	var dialogAreaTextFont = "32px Arial";
	
	var dialogSSAreaX = levelAreaX;
	var dialogSSAreaY = levelAreaY;
	var dialogSSAreaDX = levelAreaDX;
	var dialogSSAreaDY = levelAreaDY;// * 9 / 12;
	var dialogSSAreaTextFontBig = "64px Arial";
	var dialogSSAreaTextFont = "24px Arial";
	var dialogSSAreaTextFont2 = "16px Arial";
	
	var levelGridDX = 16;
	var levelGridDY = 12;
	var levelCubeSize = levelAreaDY / levelGridDY;
	
	var leftPressed = false; // left arrow, A
	var rightPressed = false; // right arrow, D
	var upPressed = false; // up arrow, W
	var downPressed = false; // down arrow, S
	var spacePressed = false; // enter, space
	var cancelPressed = false; // ESC
	var retryPressed = false; // R
	
	var startGameRequest = false;
	
	// AUDIO
	
	var assets = {
		"audio": {
			//"fire": ["audio/Fire17.wav", "audio/Fire17.mp3",
			//	"audio/Fire17.ogg"],
			//"music": ["audio/Level1.wav", "audio/Level1.mp3",
			//	"audio/Level1.ogg"]
			//"music": ["audio/Level1.ogg"]
			"music": ["audio/GSA_OST_loop.mp3", "audio/GSA_OST_loop.ogg"]
		}
	}
	
	Crafty.load(assets)
	
	// ARRAY OF SPRITES
	
	var sprites = [];
	
	// LEVEL LAYER
	
	// Helper for Coda Navigator
	function __levelLayer()
	{
	}
	
	var level = [];
	var levelPlayerX = 0;
	var levelPlayerY = 0;
	var levelPlayerXX = 0;
	var levelPlayerYY = 0;
	var levelPlayerKX = 0;
	var levelPlayerKY = 0;
	var levelGreenSlimeSpredingDir = 0;
	var levelGreenSlimesX = [];
	var levelGreenSlimesY = [];
	//@#@ var levelGreenSlimesCount = 0;
	var levelPlayerMoveStartTime = 0;
	//@#@ var levelGreenSlimeStartX = 0;
	//@#@ var levelGreenSlimeStartY = 0;
	var levelStatusFailed = false;
	var levelStartTime = 0;
	var levelCurrentTime = 0;
	
	//var playerMovedAtLeastOnce = false;
	var additionalControlsPrintedTime = 0;
	var levelShowInfoReq = false;
	var spaceNotNeededAlreadyDisplayed = false;
	var levelCargoX = -1;
	var levelCargoY = -1;
	
	function levelTick(currentTime)
	{
		if (gameLastLevelNumMessage != currentLevel)
		{
			gameLastLevelNumMessage = currentLevel;
			if (currentLevel == 6)
			{
				var i = 0;
				gameMessageAddEx("CONGRATULATION!", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("You finished our little game.", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("Thank you for playing!", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("CREDITS", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("Design and programming", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("Pavel M. Dlouhý", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("Music", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("Václav B. Špíral", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("Testing", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("Kateřina Ševčíková", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("Based on our custom web game engine (v. 0.0.1)", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("For audio used", ++i);
				gameMessageAddEx("", ++i);
				gameMessageAddEx("CraftyJS framework v. 0.9.0", ++i);
			}
			else if (currentLevel != 0)
			{
				gameMessageAdd("Level " + currentLevel);
				if (currentLevel == 1)
				{
					gameMessageAddEx("", 1);
					gameMessageAddEx("", 2);
					gameMessageAddEx("", 3);
					gameMessageAddEx("", 4);
					gameMessageAddEx("", 5);
					gameMessageAddEx("Controls:", 6);
					gameMessageAddEx("", 7);
					gameMessageAddEx("WASD or arrow keys", 8);
				}
			}
		}
		var retVal = false;
		if ((spacePressed) && (currentLevel == 0))
		{
			startGameRequest = true;
		}
		if (startGameRequest)
		{
			log("!");
			startGameRequest = false;
			gameMessages = [];
			gameMessagesY = [];
			++currentLevel;
			levelInit(currentLevel, currentTime);
		}
		//@#@_@REMOVE if ((actionPressed) && (currentLevel == 0))
		//@#@_@REMOVE {
		//@#@_@REMOVE 	//levelInit(currentLevel, currentTime);
		//@#@_@REMOVE 	if (!playerMovedAtLeastOnce)
		//@#@_@REMOVE 	{
		//@#@_@REMOVE 		playerMovedAtLeastOnce = true;
		//@#@_@REMOVE 		additionalControlsPrintedTime = currentTime;
		//@#@_@REMOVE 		spaceNotNeededAlreadyDisplayed = true;
		//@#@_@REMOVE 		gameMessageAdd("Ah, I'm sorry. I meant:");
		//@#@_@REMOVE 		gameMessageAddEx("Press SPACE to start music!", 1);
		//@#@_@REMOVE 		gameMessageAddEx("Game was already started.", 2);
		//@#@_@REMOVE 		gameMessageAddEx("Just use WASD or arrow keys.", 3);
		//@#@_@REMOVE 	}
		//@#@_@REMOVE }
		//@#@_@REMOVE if ((currentLevel == 0) && (levelPlayerX != 1)
		//@#@_@REMOVE 	&& (!spaceNotNeededAlreadyDisplayed))
		//@#@_@REMOVE {
		//@#@_@REMOVE 	playerMovedAtLeastOnce = true;
		//@#@_@REMOVE 	gameMessageAdd("Ok, SPACE is no more needed...");
		//@#@_@REMOVE 	spaceNotNeededAlreadyDisplayed = true;
		//@#@_@REMOVE }
		//@#@_@REMOVE if (playerMovedAtLeastOnce)
		//@#@_@REMOVE {
		if ((cancelPressed) && (currentLevel != 0))
		{
			if ((currentLevel == 1) && (levelPlayerX == 1)
				&& (levelPlayerY == 10)) // hack
			{
				// do nothing
			}
			else
			{
				levelShowInfoReq = true;
			}
		}
		//@#@_@REMOVE }
		if (levelShowInfoReq)
		{
			levelShowInfoReq = false;
			if ((additionalControlsPrintedTime == 0)
				|| (currentTime - additionalControlsPrintedTime > 3000))
			{
				additionalControlsPrintedTime = currentTime;
				gameMessageAdd("ADDITIONAL CONTROLS:");
				gameMessageAddEx("R - Restart level", 2);
				gameMessageAddEx("M - Audio On/Off", 3);
				//gameMessageAddEx("SPACE - Pause/Unpause game", 4);
				gameMessageAddEx("ESC - Show this info", 4);
			}
		}
		if (level[levelPlayerY][levelPlayerX] == 9)
		{
			if (level[levelPlayerY][levelPlayerX - 1] == 9)//hack
				//&& (level[levelPlayerY][levelPlayerX - 2] == 9))//hack
			{
				++currentLevel;
				levelInit(currentLevel, currentTime);
			}
			retVal = true;
		}
		if (level[levelPlayerY][levelPlayerX] == 5)
		{
			//if (currentLevel == 0)
			//{
			//	retVal = true;
			//	if ((levelPlayerXX == 0) && (levelPlayerYY == 0))
			//	{
			//		levelShowInfoReq = true;
			//		level[levelPlayerY][levelPlayerX] = 0;
			//	}
			//}
			if (currentLevel == 1)
			{
				retVal = true;
				if ((levelPlayerXX == 0) && (levelPlayerYY == 0))
				{
					levelShowInfoReq = true;
					level[levelPlayerY][levelPlayerX] = 0;
				}
			}
			else if (currentLevel == 2)
			{
				retVal = true;
				if ((levelPlayerXX == 0) && (levelPlayerYY == 0))
				{
					if (levelPlayerY == 4)
					{
						gameMessageAdd("Now it is sure thing.");
						gameMessageAddEx("You will definitely die.", 1);
					}
					else
					{
						gameMessageAdd("I think you will probably die soon.");
					}
					level[levelPlayerY][levelPlayerX] = 0;
				}
			}
			else if (currentLevel == 3)
			{
				retVal = true;
				if ((levelPlayerXX == 0) && (levelPlayerYY == 0))
				{
					gameMessageAdd("Now it is, I hope, clear that");
					gameMessageAddEx("you can move those boxes around.", 1);
					gameMessageAddEx("Right? ;-)", 2);
					level[levelPlayerY][levelPlayerX] = 0;
				}
			}
			else if (currentLevel == 4)
			{
				retVal = true;
				if ((levelPlayerXX == 0) && (levelPlayerYY == 0))
				{
					gameMessageAdd("Look, green slime seems to be");
					gameMessageAddEx("attracted to that box.", 1);
					level[levelPlayerY][levelPlayerX] = 0;
				}
			}
		}
		levelCurrentTime = currentTime;
		//@#@ if (levelStatusFailed == true)
		//@#@ {
		//@#@ 	if (retryPressed)
		//@#@ 	{
		//@#@ 		levelInit(currentLevel, currentTime);
		//@#@ 	}
		//@#@ }
		if (retryPressed)
		{
			levelInit(currentLevel, currentTime);
		}
		if ((levelPlayerXX == 0) && (levelPlayerYY == 0)
			&& (!levelStatusFailed))
		{
			if (leftPressed && !rightPressed)
			{
				levelPlayerKX = -1;
				//if (levelPlayerCanGoThere(-1, 0))
				//{
				//	levelPlayerKX = -1;
				//	levelPlayerX += levelPlayerKX;
				//	levelPlayerMoveStartTime = currentTime;
				//	levelTickGreenSlime();
				//}@#@_@REMOVE
			}
			else if (rightPressed && !leftPressed)
			{
				levelPlayerKX = 1;
			}
			else if (upPressed && !downPressed)
			{
				levelPlayerKY = -1;
				//if (levelPlayerCanGoThere(0, -1))
				//{
				//	levelPlayerKY = -1;
				//	levelPlayerY += levelPlayerKY;
				//	levelPlayerMoveStartTime = currentTime;
				//	levelTickGreenSlime();
				//}@#@_@REMOVE
			}
			else if (downPressed && !upPressed)
			{
				levelPlayerKY = 1;
				//if (levelPlayerCanGoThere(0, 1))
				//{
				//	levelPlayerKY = 1;
				//	levelPlayerY += levelPlayerKY;
				//	levelPlayerMoveStartTime = currentTime;
				//	levelTickGreenSlime();
				//}@#@_@REMOVE
			}
			if ((levelPlayerKX != 0) || (levelPlayerKY != 0))
			{
				var newPlayerX = levelPlayerX + levelPlayerKX;
				var newPlayerY = levelPlayerY + levelPlayerKY;
				if (levelPlayerCanGoThere(levelPlayerKX, levelPlayerKY))
				{
					if (level[newPlayerY][newPlayerX] == 4)
					{
						if(levelCubeIsMoveable(newPlayerX, newPlayerY,
							levelPlayerKX, levelPlayerKY))
						{
							var newCargoX = newPlayerX + levelPlayerKX;
							var newCargoY = newPlayerY + levelPlayerKY;
							level[newCargoY][newCargoX] =
								level[newPlayerY][newPlayerX];
							level[newPlayerY][newPlayerX] = 0;
							levelCargoX = newCargoX;
							levelCargoY = newCargoY;
							
							levelPlayerX = newPlayerX;
							levelPlayerY = newPlayerY;
							levelPlayerMoveStartTime = currentTime;
							levelTickGreenSlime();
						}
						else
						{
							levelPlayerKX = 0;
							levelPlayerKY = 0;
						}
					}
					else
					{
						levelPlayerX = newPlayerX;
						levelPlayerY = newPlayerY;
						levelPlayerMoveStartTime = currentTime;
						levelTickGreenSlime();
					}
				}
				else
				{
					levelPlayerKX = 0;
					levelPlayerKY = 0;
				}
			}
		}
		if ((levelPlayerKX != 0) || (levelPlayerKY != 0))
		{
			var deltaTime = (currentTime + 16 - levelPlayerMoveStartTime);
			if (levelPlayerKX != 0)
			{
				levelPlayerXX = levelPlayerKX * deltaTime / 2;
				if (levelPlayerXX >= levelCubeSize)
				{
					//@#@ levelPlayerX += 1;
					levelPlayerXX = 0;
					levelPlayerKX = 0;
					levelPlayerMoveStartTime = 0;
					levelCargoX = -1;
					levelCargoY = -1;
				}
				else if (levelPlayerXX <= -levelCubeSize)
				{
					//@#@ levelPlayerX -= 1;
					levelPlayerXX = 0;
					levelPlayerKX = 0;
					levelPlayerMoveStartTime = 0;
					levelCargoX = -1;
					levelCargoY = -1;
				}
			}
			else if (levelPlayerKY != 0)
			{
				levelPlayerYY = levelPlayerKY * deltaTime / 2;
				if (levelPlayerYY >= levelCubeSize)
				{
					//@#@ levelPlayerY += 1;
					levelPlayerYY = 0;
					levelPlayerKY = 0;
					levelPlayerMoveStartTime = 0;
					levelCargoX = -1;
					levelCargoY = -1;
				}
				else if (levelPlayerYY <= -levelCubeSize)
				{
					//@#@ levelPlayerY -= 1;
					levelPlayerYY = 0;
					levelPlayerKY = 0;
					levelPlayerMoveStartTime = 0;
					levelCargoX = -1;
					levelCargoY = -1;
				}
			}
		}
		
		for (i = 0; i < levelGridDY; ++i)
		{
			for (j = 0; j < levelGridDX; ++j)
			{
				if (level[i][j] == 5)
				{
					levelQuestionMarkDraw(j, i);
				}
			}	
		}
		levelPlayerDraw();
		for (i = 0; i < levelGridDY; ++i)
		{
			for (j = 0; j < levelGridDX; ++j)
			{
				if (level[i][j] == 2)
				{
					levelGreenSlimeDraw(j, i);
				}
				else if (level[i][j] == 8)
				{
					levelWallDraw(j, i);
				}
				else if (level[i][j] == 4)
				{
					levelYellowBoxDraw(j, i);
				}
				else if (level[i][j] == 3)
				{
					levelDoorDraw(j, i);
				}
			}	
		}
		if (currentLevel == 0)
		{
			drawDialogStartScreen();
		}
		if (levelStatusFailed)
		{
			if (!levelStatusFailedPrinted)
			{
				levelStatusFailedPrinted = true;
				gameMessageAdd("You are dead!");
				gameMessageAddEx("", 1);
				gameMessageAddEx("Press 'R' to try again.", 1);
			}
			//drawDialog(1);
		}
		if (currentTime - levelStartTime > 2000)
		{
			levelStartTime = 0;
		}
		if ((levelPlayerKX != 0) || (levelPlayerKY != 0) || levelStartTime != 0
			|| leftPressed || rightPressed || upPressed || downPressed)
		{
			retVal = true;
		}
		return retVal;
	}
	
	function levelTickGreenSlime()
	{
		if (level[levelPlayerY][levelPlayerX]==2)
		{
			levelStatusFailed = true;
			return;
		}
		
		var distance = 99;
		var slimeX = -1;
		var slimeY = -1;
		var spreadingKX = 0;
		var spreadingKY = 0;
		var spreadingDir = "";
		for (i = 0; i < levelGridDY; ++i)
		{
			for (j = 0; j < levelGridDX; ++j)
			{
				if (level[i][j] == 4)
				{
					//log("Box found: (" + j + ", " + i + ")");
					var dir = 0; // 0 - right, 1 - left, 2 - up, 3 - down 
					var dirKX = [1, -1, 0, 0];
					var dirKY = [0, 0, -1, 1];
					var dirChar = ["R", "L", "U", "D"];
					var invDirChar = ["L", "R", "D", "U"];
					while (dir < 4)
					{
						var d = 0;
						var lX = j + dirKX[dir] + d * dirKX[dir];
						var lY = i + dirKY[dir] + d * dirKY[dir];
						while ((level[lY][lX] == 0)
							&& ((lX != levelPlayerX) || (lY != levelPlayerY)))
						{
							++d;
							lX += dirKX[dir];
							lY += dirKY[dir];
						}
						//log(" Dist: " + d + "; dir: " + dirChar[dir]);
						if (level[lY][lX] == 2)
						{
							//log("  Slime found: (" + lX + ", " + lY
							//	+ "); dist: " + d + "; dir: "
							//	+ invDirChar[dir]);
							if (distance > d)
							{
								distance = d;
								slimeX = lX;
								slimeY = lY;
								spreadingKX = -dirKX[dir];
								spreadingKY = -dirKY[dir];
								spreadingDir = invDirChar[dir];
							}
						}
						++dir;
					}
				}
			}
		}
		if (slimeX != -1)
		{
			//log("x: " + (slimeX + spreadingKX) + "; y: "
			//	+ (slimeY + spreadingKY));
			if (levelGreenSlimCanGoThere(slimeX + spreadingKX,
				slimeY + spreadingKY))
			{
				levelGreenSlimeAdd(slimeX + spreadingKX, slimeY + spreadingKY);
				levelGreenSlimeSpredingDir = spreadingDir;
				return;
			}
			else
			{
				log("Something is wrong!");
			}
		}
		
		var idx = 0;
		while (idx < levelGreenSlimesX.length)
		{
			var x = levelGreenSlimesX[idx];
			var y = levelGreenSlimesY[idx];
			if (levelGreenSlimCanGoThere(x - 1, y))
			{
				//log("L!");
				levelGreenSlimeAdd(x - 1, y);
				levelGreenSlimeSpredingDir = "L";
				break;
			}
			if (levelGreenSlimCanGoThere(x, y + 1))
			{
				//log("D!");
				levelGreenSlimeAdd(x, y + 1);
				levelGreenSlimeSpredingDir = "D";
				break;
			}
			if (levelGreenSlimCanGoThere(x + 1, y))
			{
				//log("R!");
				levelGreenSlimeAdd(x + 1, y);
				levelGreenSlimeSpredingDir = "R";
				break;
			}
			if (levelGreenSlimCanGoThere(x, y - 1))
			{
				//log("U!");
				levelGreenSlimeAdd(x, y - 1);
				levelGreenSlimeSpredingDir = "U";
				break;
			}
			++idx;
		}
	}
	
	function levelInit(lvl, currentTime)
	{
		// 1 - PLAYER
		// 2 - GREEN SLIME
		// 3 - ENTRANCE
		// 4 - YELLOW BOX
		// 5 - QUESTION MARK
		// 8 - WALL
		// 9 - EXIT
		if (lvl == 0)
		{
			level = [
				[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[3,1,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0],
			];
		}
		else if (lvl == 1)
		{
			level = [
				[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0],
				[8,0,0,0,0,0,0,0,0,5,0,0,0,0,0,8,0,0],
				[8,0,8,8,8,8,8,8,8,8,8,8,8,8,0,8,0,0],
				[8,0,8,0,0,0,0,0,0,0,0,0,2,8,0,8,0,0],
				[8,0,8,0,0,0,0,0,0,8,8,8,0,8,0,8,0,0],
				[8,0,8,0,0,0,0,0,0,0,0,8,0,8,0,8,0,0],
				[8,0,8,0,0,0,0,0,0,0,0,8,0,8,0,8,0,0],
				[8,0,8,0,0,0,0,0,0,0,0,0,0,8,0,8,0,0],
				[8,0,8,0,0,0,0,0,0,0,0,0,0,8,0,8,0,0],
				[8,0,8,0,0,0,0,0,0,0,0,0,0,8,0,8,0,0],
				[3,1,8,0,0,0,0,0,0,0,0,0,0,8,0,9,9,9],
				[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0],
			];
		}
		else if (lvl == 2) // introduce green slime
		{
			level = [
				[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,2,8,0,0],
				[8,0,8,8,8,8,8,8,8,0,8,8,8,8,0,8,0,0],
				[8,0,8,0,0,0,8,0,0,0,0,0,0,8,0,8,0,0],
				[8,5,8,0,8,0,8,8,8,8,8,0,0,8,0,8,0,0],
				[8,0,8,0,8,0,8,0,0,0,8,0,0,8,0,8,0,0],
				[8,5,0,0,8,0,8,0,8,0,8,0,0,0,0,8,0,0],
				[8,0,8,0,8,0,8,0,8,0,8,0,0,0,0,8,0,0],
				[8,0,8,0,8,0,8,0,8,0,8,0,0,0,0,8,0,0],
				[8,0,8,0,8,0,8,0,8,0,8,8,8,0,8,8,0,0],
				[3,1,8,0,8,0,0,0,8,0,0,0,0,0,0,9,9,9],
				[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0],
			];
		}
		else if (lvl == 3) // introduce yellow boxes
		{
			level = [
				[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,2,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,8,8,8,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,8,0,8,8,8,8,8,8,8,0,0,0,0,0,8,0,0],
				[8,0,0,0,4,0,0,0,0,8,8,0,0,0,0,8,0,0],
				[8,8,4,8,8,8,8,0,0,5,8,0,0,0,0,8,0,0],
				[8,0,0,0,4,0,8,8,8,0,8,8,0,0,0,8,0,0],
				[8,8,8,8,8,0,0,0,8,0,0,8,0,0,0,8,0,0],
				[8,0,0,0,8,8,8,0,8,8,0,8,8,8,0,8,0,0],
				[3,1,8,0,0,0,0,4,0,8,0,0,0,0,0,9,9,9],
				[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0],
			];
		}
		else if (lvl == 4) // yellow boxes vs. green slime
		{
			level = [
				[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,2,8,0,0],
				[8,0,0,0,8,8,8,8,8,8,8,8,8,8,2,8,0,0],
				[8,0,8,0,8,0,4,0,0,0,0,0,0,8,0,8,0,0],
				[8,0,8,0,8,0,0,0,8,8,8,0,4,8,0,8,0,0],
				[8,0,8,0,8,0,8,8,8,8,8,0,0,8,0,8,0,0],
				[8,0,8,5,8,0,8,0,0,0,8,8,0,8,0,8,0,0],
				[8,4,8,0,8,0,8,0,4,0,0,0,0,8,0,8,0,0],
				[8,0,8,0,8,0,8,0,4,0,0,4,0,8,0,8,0,0],
				[8,0,8,0,0,0,8,0,4,8,8,8,8,8,0,8,0,0],
				[3,1,8,0,4,0,8,0,0,0,0,0,0,0,0,9,9,9],
				[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0],
			];
		}
		else if (lvl == 5) // last minute
		{
			level = [
				[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,8,0,0],
				[8,0,8,0,8,0,0,0,0,0,0,0,0,8,0,8,0,0],
				[8,0,8,0,8,0,0,0,0,0,0,0,0,8,0,8,0,0],
				[8,0,8,0,8,0,0,0,0,0,0,0,0,8,0,8,0,0],
				[8,0,8,0,8,0,0,0,0,0,0,0,0,8,0,8,0,0],
				[8,0,8,0,8,8,0,0,0,0,0,0,0,8,0,8,0,0],
				[8,0,8,0,0,8,8,8,8,8,8,8,0,8,0,8,0,0],
				[3,1,8,2,0,0,0,0,0,0,0,0,0,8,0,9,9,9],
				[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0],
			];
		}
		else if (lvl == 6) // last one
		{
			level = [
				[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,2,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[3,1,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0],
				[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0],
			];
		}
		levelLastCurrentTime = 0;
		levelPlayerX = 0;
		levelPlayerY = 0;
		levelPlayerXX = 0;
		levelPlayerYY = 0;
		levelPlayerKX = 0;
		levelPlayerKY = 0;
		levelPlayerMoveStartTime = 0;
		levelGreenSlimeSpredingDir = 0;
		levelGreenSlimesX = [];
		levelGreenSlimesY = [];
		levelStatusFailed = false;
		levelStatusFailedPrinted = false;
		levelStartTime = currentTime;
		levelCurrentTime = currentTime;
		//@#@ levelGreenSlimesCount = 0;
		//@#@ levelGreenSlimeStartX = 0;
		//@#@ levelGreenSlimeStartY = 0;
		for (i = 0; i < levelGridDY; ++i)
		{
			for (j = 0; j < levelGridDX; ++j)
			{
				if (level[i][j] == 1)
				{
					level[i][j] = 0;
					levelPlayerX = j;
					levelPlayerY = i;
					break;
				}
			}
		}
		for (i = 0; i < levelGridDY; ++i)
		{
			for (j = 0; j < levelGridDX; ++j)
			{
				if (level[i][j] == 2)
				{
					levelGreenSlimeAdd(j, i);
				}
			}
		}	
	}
	
	function levelCubeIsMoveable(x, y, deltaX, deltaY)
	{
		var item = level[y][x];
		if (item == 4)
		{
			if(level[y + deltaY][x + deltaX] == 0)
			{
				return true;
			}
		}
		return false;
	}
	
	function levelGreenSlimeAdd(x, y)
	{
		levelGreenSlimesX.push(x);
		levelGreenSlimesY.push(y);
		level[y][x] = 2;
		if ((levelPlayerX == x) && (levelPlayerY == y))
		{
			levelStatusFailed = true;
			levelStatusFailedPrinted = false;
		}
		//@#@ ++levelGreenSlimesCount;
	}
	
	function levelGreenSlimCanGoThere(x, y)
	{
		var item = level[y][x];
		if ((item == 0) || (item == 4) || (item == 5))
		{
			return true;
		}
		return false;
	}
	
	function levelGreenSlimeDraw(x, y)
	{
		if (levelGreenSlimesX.length == 0)
		{
			log("levelGreenSlimeDraw: levelGreenSlimesX.length is zero!");
			return;
		}
		var idxOfLast = levelGreenSlimesX.length - 1;
		if ((levelGreenSlimesX[idxOfLast] != x) ||
			(levelGreenSlimesY[idxOfLast] != y))
		{
			levelQuadDraw(x * levelCubeSize, y * levelCubeSize, levelCubeSize,
				levelCubeSize, levelGreenSlimeColor);
		}
		var deltaTime = (levelCurrentTime + 16 - levelPlayerMoveStartTime);
		//var percent = deltaTime / 2;
		//if (percent > 100)
		//{
		//	percent = 100;
		//}
		var cubeSize = deltaTime / 2;
		if (cubeSize == 0)
		{
			return;
		}
		if (cubeSize > levelCubeSize)
		{
			cubeSize = levelCubeSize;
		}
		if (levelGreenSlimeSpredingDir == "L")
		{
			levelQuadDraw(x * levelCubeSize + levelCubeSize - cubeSize,
				y * levelCubeSize, cubeSize,
				levelCubeSize, levelGreenSlimeColor);
		}
		else if (levelGreenSlimeSpredingDir == "R")
		{
			levelQuadDraw(x * levelCubeSize,
				y * levelCubeSize, cubeSize,
				levelCubeSize, levelGreenSlimeColor);
		}
		else if (levelGreenSlimeSpredingDir == "U")
		{
			levelQuadDraw(x * levelCubeSize,
				y * levelCubeSize + levelCubeSize - cubeSize, levelCubeSize,
				cubeSize, levelGreenSlimeColor);
		}
		else if (levelGreenSlimeSpredingDir == "D")
		{
			levelQuadDraw(x * levelCubeSize, y * levelCubeSize, levelCubeSize,
				cubeSize, levelGreenSlimeColor);
		}
		else
		{
			levelQuadDraw(x * levelCubeSize, y * levelCubeSize, levelCubeSize,
				levelCubeSize, levelGreenSlimeColor);
		}
	}
	
	function levelDoorDraw(x, y)
	{
		var deltaTime = levelCurrentTime - levelStartTime - 500;
		if (deltaTime < 0)
		{
			deltaTime = 0;
		}
		var doorDY = deltaTime / 20;
		if (doorDY > levelCubeSize)
		{
			doorDY = levelCubeSize;
		}
		levelQuadDraw(x * levelCubeSize, y * levelCubeSize, levelCubeSize,
			doorDY, levelWallColor);
	}
	
	function levelPlayerCanGoThere(deltaX, deltaY)
	{
		var item = level[levelPlayerY + deltaY][levelPlayerX + deltaX];
		if ((item == 0) || (item == 2) || (item == 4) || (item == 5)
			|| (item == 9))
		{
			return true;
		}
		return false;
	}
	
	function levelPlayerDraw()
	{
		var x = (levelPlayerX - levelPlayerKX) * levelCubeSize + levelPlayerXX;
		var y = (levelPlayerY - levelPlayerKY) * levelCubeSize + levelPlayerYY;
		levelQuadDraw(x, y, levelCubeSize, levelCubeSize, levelPlayerColor);
	}
	
	function levelQuestionMarkDraw(x, y)
	{
		ctx.font = levelAreaTextFont;
		ctx.fillStyle = levelAreaTextColor;
		//@#@_@TODO? ctx.fillStyle = levelGreenSlimeColor;
	
		var text = "?";
		var w = ctx.measureText(text).width;
		ctx.fillText(text,
			levelAreaX + x * levelCubeSize + levelCubeSize / 2 - w / 2,
			levelAreaY + y * levelCubeSize + levelCubeSize / 2 + 12);
		//@#@ ctx.fillText(text, levelAreaX + x * levelCubeSize + 28,
		//@#@	levelAreaY + y * levelCubeSize + 38);
	}
		
	function levelWallDraw(x, y)
	{
		levelQuadDraw(x * levelCubeSize, y * levelCubeSize, levelCubeSize,
			levelCubeSize, levelWallColor);
	}
	
	function levelYellowBoxDraw(x, y)
	{
		if ((levelCargoX == x) && (levelCargoY == y))
		{
			var lX = (x - levelPlayerKX) * levelCubeSize + levelPlayerXX;
			var lY = (y - levelPlayerKY) * levelCubeSize + levelPlayerYY;
			levelQuadDraw(lX, lY, levelCubeSize,
				levelCubeSize, levelYellowBoxColor);
		}
		else
		{
			levelQuadDraw(x * levelCubeSize, y * levelCubeSize, levelCubeSize,
				levelCubeSize, levelYellowBoxColor);
		}
	}
	
	function levelQuadDraw(x, y, dx, dy, color)
	{
		var xDes = x;
		var yDes = y;
		var dxDes = dx;
		var dyDes = dy;
		if (levelStartTime != 0)
		{
			var deltaTime = levelCurrentTime - levelStartTime;
			var percent = deltaTime / 5;
			if (percent > 100)
			{
				percent = 100;
			}
			xSrc = xDes + dxDes / 2;
			ySrc = yDes + dyDes / 2;
			dxSrc = 0;
			dySrc = 0;
			xDes = xSrc + (xDes - xSrc) * percent / 100;
			yDes = ySrc + (yDes - ySrc) * percent / 100;
			dxDes = dxSrc + (dxDes - dxSrc) * percent / 100;
			dyDes = dySrc + (dyDes - dySrc) * percent / 100;
		} 
		gameQuadDraw(levelAreaX + xDes, levelAreaY + yDes, dxDes, dyDes, color);
	}
		
	// GAME LAYER
	
	// Helper for Coda Navigator
	function __gameLayer()
	{
	}
	
	// DATA
	
	var gameLastLevelNumMessage = 0;
	var currentLevel = 0
	var gameMessages = [];
	var gameMessagesY = [];
	var gameAudioEnabled = true;
	var gameGameplayMusicPlaying = false;
	//var gameIsPaused = false;
	
	// GAME MESSAGES
	
	function gameMessageAdd(mess)
	{
		gameMessageAddEx(mess, 0)
	}
	
	function gameMessageAddEx(mess, offsetY)
	{
		gameMessages.push(mess);
		gameMessagesY.push((levelAreaY + levelAreaDY - 20 + offsetY * 32) * 10);
	}
	
	var gameMessageLastTime = 0;
	
	function gameMessagesDraw()
	{
		if (gameMessageLastTime == 0)
		{
			gameMessageLastTime = levelCurrentTime;
		}
		var deltaTime = levelCurrentTime - gameMessageLastTime;
		if (deltaTime > 16)
		{
			deltaTime = 16;
		}
		gameMessageLastTime = levelCurrentTime;
				
		var retVal = false;
		var idx = 0;
		while (idx < gameMessages.length)
		{
			if (gameMessagesY[idx] > 0)
			{
				ctx.font = levelAreaGameMessagesTextFont;
				
				var x = levelAreaX + levelAreaDX / 2;
				var y = gameMessagesY[idx] / 10;
				
				var edge = 2;
				ctx.fillStyle = levelAreaGameMessagesTextColorEdge;
				var textWidth = ctx.measureText(gameMessages[idx]).width;
				x -= textWidth / 2;
				ctx.fillText(gameMessages[idx], x - edge, y - edge);
				ctx.fillText(gameMessages[idx], x + 0, y - edge);
				ctx.fillText(gameMessages[idx], x + edge, y - edge);
				ctx.fillText(gameMessages[idx], x - edge, y + 0);
				ctx.fillText(gameMessages[idx], x + edge, y + 0);
				ctx.fillText(gameMessages[idx], x - edge, y + edge);
				ctx.fillText(gameMessages[idx], x + 0, y + edge);
				ctx.fillText(gameMessages[idx], x + edge, y + edge);
				ctx.fillStyle = levelAreaGameMessagesTextColor;
				ctx.fillText(gameMessages[idx], x, y);
				
				gameMessagesY[idx] = gameMessagesY[idx] - deltaTime;
				retVal = true;
			}
			++idx;
		}
		return retVal;
	}
	
	function gameQuadDraw(x, y, dx, dy, color)
	{
		ctx.beginPath();
		ctx.rect(x, y, dx, dy);
		ctx.fillStyle = color;
		ctx.fill();
		ctx.closePath();
	}
	
	// INPUT
	
	function keyDownHandler(e) { // see http://keycode.info/
		var retVal = false;
		if(e.keyCode == 37) {
			leftPressed = true;
			retVal = true;
		}
		else if(e.keyCode == 38) {
			upPressed = true;
			retVal = true;
		}
		else if(e.keyCode == 39) {
			rightPressed = true;
			retVal = true;
		}
		else if(e.keyCode == 40) {
			downPressed = true;
			retVal = true;
		}
		else if(e.keyCode == 65) {
			leftPressed = true;
			retVal = true;
		}
		else if(e.keyCode == 87) {
			upPressed = true;
			retVal = true;
		}
		else if(e.keyCode == 68) {
			rightPressed = true;
			retVal = true;
		}
		else if(e.keyCode == 83) {
			downPressed = true;
			retVal = true;
		}
		//else if(e.keyCode == 13) { // ENTER
		//	actionPressed = true;
		//	return true;
		//}
		else if(e.keyCode == 32) { // SPACE
			spacePressed = true;
			//if (currentLevel != 0)
			//{
			//	gameIsPaused = !gameIsPaused; 
			//}
			//if (!gameIsPaused)
			//{
			retVal = true;
			//}
		}
		else if(e.keyCode == 27) { // ESC
			cancelPressed = true;
			retVal = true;
		}
		else if(e.keyCode == 82) { // R
			retryPressed = true;
			retVal = true;
		}
		else if(e.keyCode == 77) { // M
			if (currentLevel != 0) // hack
			{
				gameTriggerAudioRequest = true;
			}
			retVal = true;
		}
		if ((retVal) && (currentLevel == 0))
		{
			startGameRequest = true;
		}
		return retVal;
	}
	
	function keyUpHandler(e) {
		if(e.keyCode == 37) {
			leftPressed = false;
			return true;
		}
		else if(e.keyCode == 38) {
			upPressed = false;
			return true;
		}
		else if(e.keyCode == 39) {
			rightPressed = false;
			return true;
		}
		else if(e.keyCode == 40) {
			downPressed = false;
			return true;
		}
		else if(e.keyCode == 65) {
			leftPressed = false;
			return true;
		}
		else if(e.keyCode == 87) {
			upPressed = false;
			return true;
		}
		else if(e.keyCode == 68) {
			rightPressed = false;
			return true;
		}
		else if(e.keyCode == 83) {
			downPressed = false;
			return true;
		}
		//else if(e.keyCode == 13) {
		//	actionPressed = false;
		//	return true;
		//}
		else if(e.keyCode == 32) {
			spacePressed = false;
			return true;
		}
		else if(e.keyCode == 27) {
			cancelPressed = false;
			return true;
		}
		else if(e.keyCode == 82) {
			retryPressed = false;
			return true;
		}
		return false;
	}
	
	function mouseMoveHandler(e) {
		return true;
	}
	
	// INIT
	
	function init(currentTime)
	{
		gameDisplaySpaceNotNeeded = true;
		gameLastLevelNumMessage = 0;
		currentLevel = 0;
		if (devStartFromLevel != 0)
		{
			currentLevel = devStartFromLevel;
		}
		gameMessages = [];
		gameMessagesY = [];
		
		levelInit(currentLevel, currentTime);
		if (currentLevel == 0)
		{
			gameMessageAdd("Press SPACE to start game.");
		}		
	}
	
	// DRAW
	
	function drawBackground() {
		ctx.beginPath();
		ctx.rect(levelAreaX, levelAreaY, levelAreaDX, levelAreaDY);
		ctx.fillStyle = levelAreaBGColor;
		ctx.fill();
		ctx.closePath();
	}
	
	// TICK
	
	var doOnce = true;
	var gameTriggerAudioRequest = false;
	var startMusicOnce = true;
	
	function tick(currentTime)
	{
		if (doOnce)
		{
			doOnce = false;
			init(currentTime);
		}
		//if (gameIsPaused)
		//{
		//	return false;
		//}
		if ((gameAudioEnabled) && (layer0AudioUnlocked) && startMusicOnce)
		{
			startMusicOnce = false;
			if (gameGameplayMusicPlaying)
			{
				Crafty.audio.stop();
			}
			Crafty.audio.play("music", -1, 1.0);
			gameGameplayMusicPlaying = true;
		}

		if (gameTriggerAudioRequest)
		{
			gameTriggerAudioRequest = false;
			gameAudioEnabled = !gameAudioEnabled;
			if (gameAudioEnabled)
			{
				Crafty.audio.play("music", -1, 1.0);
				gameGameplayMusicPlaying = true;
			}
			else
			{
				Crafty.audio.stop();
				gameGameplayMusicPlaying = false;
			}
		}
		drawBackground();
		
		var retVal = levelTick(currentTime);
		return gameMessagesDraw() || retVal;
		//return false; // true - call me again
	}
	
	// DIALOGS
	
	function drawDialog(context)
	{
		drawDialogQuad(0, 0, dialogAreaDX, dialogAreaDY, dialogAreaBGColor);
		if (context == 1)
		{
			ctx.font = dialogAreaTextFont;
			ctx.fillStyle = dialogAreaTextColor;
		
			ctx.fillText("You failed!", dialogAreaX + dialogAreaDX / 2 - 75,
				dialogAreaY + dialogAreaDY / 2 - 30);
			ctx.fillText("Press ‘R’ to try again.",
				dialogAreaX + dialogAreaDX / 2 - 150,
				dialogAreaY + dialogAreaDY / 2 + 50);
		}
		
		drawDialogQuad(0, 0, dialogAreaDX, 1, dialogAreaTextColor);
		drawDialogQuad(dialogAreaDX - 1, 0, 1, dialogAreaDY,
			dialogAreaTextColor);
		drawDialogQuad(0, dialogAreaDY - 1, dialogAreaDX, 1,
			dialogAreaTextColor);
		drawDialogQuad(0, 0, 1, dialogAreaDY, dialogAreaTextColor);
	}
	
	function drawDialogStartScreen()
	{
		//hack for start screen
		var dialogAreaXBackup = dialogAreaX;
		var dialogAreaYBackup = dialogAreaY;
		dialogAreaX = levelAreaX;
		dialogAreaY = levelAreaY;
		
		drawDialogQuad(0, 0, dialogSSAreaDX, dialogSSAreaDY, dialogSSAreaBGColor);

		ctx.font = dialogSSAreaTextFontBig;
		ctx.fillStyle = levelGreenSlimeColor;//dialogAreaTextColor;
		//@#@_@TODO? ctx.fillStyle = levelGreenSlimeColor;
	
		ctx.fillText("Green Slime Apocalypse",
			dialogSSAreaX + dialogSSAreaDX / 2 - 330, dialogSSAreaY + 140);
	
		ctx.font = dialogSSAreaTextFont2;
		ctx.fillStyle = dialogAreaTextColor;
		ctx.fillText("v. 1.0.0", dialogSSAreaX + dialogSSAreaDX / 2 + 315,
			dialogSSAreaY + 160);
	
		ctx.font = dialogSSAreaTextFont;
		ctx.fillText("Game made for Ludum Dare 42",
			dialogSSAreaX + dialogSSAreaDX / 2 - 175,
			dialogSSAreaY + dialogSSAreaDY / 2 - 30);
		ctx.font = dialogSSAreaTextFont2;
		ctx.fillText("Theme: Running out of space",
			dialogSSAreaX + dialogSSAreaDX / 2 - 110,
			dialogSSAreaY + dialogSSAreaDY / 2 - 30 + 20);
		
		//if ((actionPressed) && (levelPlayerX == 1))
		//{
		//	ctx.font = dialogSSAreaTextFontBig;
		//	ctx.fillText("CONTROLS: WASD or arrow keys",
		//		dialogSSAreaX + dialogSSAreaDX / 2 - 315,
		//		dialogSSAreaY + dialogSSAreaDY / 2 + 125);
		//}
		//else
		//{
		//	ctx.font = dialogSSAreaTextFont;
		//	ctx.fillText("CONTROLS: WASD or arrow keys",
		//		dialogSSAreaX + dialogSSAreaDX / 2 - 125,
		//		dialogSSAreaY + dialogSSAreaDY / 2 + 110);
		//}
		
		ctx.font = dialogSSAreaTextFont;
		ctx.fillText(
			"Copyright © 2018, Pavel M. Dlouhy (game) and Vaclav B. Spiral (music)",
			dialogSSAreaX + dialogSSAreaDX / 2 - 380,
			dialogSSAreaY + dialogSSAreaDY - 50);
		//ctx.fillText("",
		//	dialogSSAreaX + dialogSSAreaDX / 2 - 145,
		//	dialogSSAreaY + dialogSSAreaDY - 50 + 26);
		
		//ctx.fillStyle = dialogSSAreaGoTextColor;
		//ctx.fillText("GO ==>",
		//	dialogSSAreaX + dialogSSAreaDX / 2 - 50,
		//	dialogSSAreaY + dialogSSAreaDY + 45);
		
		drawDialogQuad(0, 0, dialogSSAreaDX, 1, dialogAreaTextColor);
		drawDialogQuad(dialogSSAreaDX - 1, 0, 1, dialogSSAreaDY,
			dialogAreaTextColor);
		drawDialogQuad(0, dialogSSAreaDY - 1, dialogSSAreaDX, 1,
			dialogAreaTextColor);
		drawDialogQuad(0, 0, 1, dialogSSAreaDY, dialogAreaTextColor);
		
		dialogAreaX = dialogAreaXBackup;
		dialogAreaY = dialogAreaYBackup;
	}
	
	function drawDialogQuad(x, y, dx, dy, color)
	{
		ctx.beginPath();
		ctx.rect(dialogAreaX + x, dialogAreaY + y, dx, dy);
		ctx.fillStyle = color;
		ctx.fill();
		ctx.closePath();
	}
	
	// LAYER 1
	
	// Helper for Coda Navigator
	function __layer1()
	{
	}
	
	// LAYER 1 - DBG

	function layer1DbgDrawBackground() {
		ctx.beginPath();
		ctx.rect(dbgAreaX, dbgAreaY, dbgAreaDX, dbgAreaDY);
		ctx.fillStyle = dbgAreaBGColor;
		ctx.fill();
		ctx.closePath();
	}

	function layer1DbgTick(currentTime)
	{
		++layer1DbgTickCall;
		layer1DbgDrawBackground();
		
		var framesPerSecond = 0;
		
		if (layer1LastCurrentTime != 0)
		{
			if (layer1LastCurrentTime < currentTime)
			{
				framesPerSecond = 1000 / (currentTime - layer1LastCurrentTime);
			}
		}
		
		var yK = 0;
		
		ctx.font = dbgAreaTextFont;
		ctx.fillStyle = dbgAreaTextColor;
		
		ctx.fillText("CurrentTime: " + currentTime, dbgAreaX + dbgAreaTextX,
			dbgAreaY + dbgAreaTextY + yK++ * dbgAreaTextYK);
		ctx.fillText("DrawCall: " + layer1DbgTickCall,
			dbgAreaX + dbgAreaTextX,
			dbgAreaY + dbgAreaTextY + yK++ * dbgAreaTextYK);
		var tickMilliseconds = Math.floor(layer1layer0TickDuration / 1000);
		ctx.fillText("LastTick: " + tickMilliseconds + "."
			+ (Math.floor(layer1layer0TickDuration / 100)
			- Math.floor(tickMilliseconds * 10)) + " ms",
			dbgAreaX + dbgAreaTextX,
			dbgAreaY + dbgAreaTextY + yK++ * dbgAreaTextYK);
		ctx.fillText("dbgEventCall: " + layer1DbgEventCall,
			dbgAreaX + dbgAreaTextX,
			dbgAreaY + dbgAreaTextY + yK++ * dbgAreaTextYK);
		ctx.fillText("FPS: " + Math.round(framesPerSecond),
			dbgAreaX + dbgAreaTextX,
			dbgAreaY + dbgAreaTextY + yK++ * dbgAreaTextYK);
		ctx.fillText("MouseX: " + layer1MouseX, dbgAreaX + dbgAreaTextX,
			dbgAreaY + dbgAreaTextY + yK++ * dbgAreaTextYK);
		ctx.fillText("MouseY: " + layer1MouseY, dbgAreaX + dbgAreaTextX,
			dbgAreaY + dbgAreaTextY + yK++ * dbgAreaTextYK);
		
		layer1LastCurrentTime = currentTime;
	}

	// LAYER 1 - MAIN
	
	var layer1LastCurrentTime = 0;
	var layer1MouseX = 0;
	var layer1MouseY = 0;
	
	//var layer1DbgPause = false;
	var layer1DbgTickCall = 0;
	var layer1DbgEventCall = 0;
	var layer1layer0TickDuration = 0;
	
	function layer1KeyDownHandler(e) { // see http://keycode.info/
		++layer1DbgEventCall;
		return keyDownHandler(e);
	}
	
	function layer1KeyUpHandler(e) {
		++layer1DbgEventCall;
		return keyUpHandler(e);
	}
	
	function layer1MouseMoveHandler(e) {
		++layer1DbgEventCall;
		layer1MouseX = e.clientX - canvas.offsetLeft;
		//if(relativeX > 0 && relativeX < canvas.width) {
		//}
		layer1MouseY = e.clientY - canvas.offsetTop;
		return mouseMoveHandler(e);
	}

	function layer1Tick(currentTime, dbgSupport)
	{
		++layer1DbgTickCall;
		var retVal = tick(currentTime);
		if (dbgSupport)
		{
			layer1DbgTick(currentTime);
		}
		return retVal;
	}

	// LAYER 0
	
	// Helper for Coda Navigator
	function __layer0()
	{
	}
	
	// LAYER 0 - CONFIG
	
	var layer0KeyboardSupport = true;
	var layer0MouseSupport = false;
	var layer0DbgSupport = false;
	var layer0LogSupport = true;
	var layer0ErrorAlert = false;
	if (!finalBuild)
	{
		layer0DbgSupport = true;
	}
	
	// LAYER 0 - VARIABLES
	
	var layer0AnimationFrameRequested = 0;
	var layer0AudioUnlocked = false;
	
	// LAYER 0 - FUNCTIONS
	
	function log(string)
	{
		if (layer0LogSupport)
		{
			console.log(string);
		}
	}
	
	function error(message)
	{
		log("ERROR: " + message);
		if (layer0ErrorAlert)
		{
			//@#@ alert(message);
		}
	}
	
	function layer0RequestAnimationFrame()
	{
		++layer0AnimationFrameRequested;
		if (layer0AnimationFrameRequested == 1)
		{
			// https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame
			requestAnimationFrame(layer0Tick);
			//alert("Test");
		}
	}
	
	function layer0KeyDownHandler(e) {
		if (layer1KeyDownHandler(e))
		{
			layer0AudioUnlocked = true;
			layer0RequestAnimationFrame();
		}
	}
	
	function layer0KeyUpHandler(e) {
		if (layer1KeyUpHandler(e))
		{
			layer0RequestAnimationFrame();
		}
	}
	
	function layer0MouseMoveHandler(e) {
		if (layer1MouseMoveHandler(e))
		{
			layer0RequestAnimationFrame();
		}
	}
	
	function layer0Tick(currentTime)
	{
		var t0 = performance.now();
		layer0AnimationFrameRequested = 0;
		if (layer1Tick(currentTime, layer0DbgSupport))
		{
			layer0RequestAnimationFrame();
		}
		var t1 = performance.now();
		layer1layer0TickDuration = Math.floor(t1 * 1000 - t0 * 1000);
	}

	// LAYER 0 - ADD LISTENERS AND INVOKE ENTRY POINT

	if (layer0KeyboardSupport)
	{
		document.addEventListener("keydown", layer0KeyDownHandler, false);
		document.addEventListener("keyup", layer0KeyUpHandler, false);
	}
	if (layer0MouseSupport)
	{
		document.addEventListener("mousemove", layer0MouseMoveHandler, false);
	}

	layer0RequestAnimationFrame();
</script>

</body>
</html>